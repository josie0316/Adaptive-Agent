<!DOCTYPE html>
<html>

<head>
    <title>Gym-cooking</title>
    <script src="../static/js/socket.io.min.js"></script>
</head>
<style>
    html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    .agent_communication {
        width: 480px;
        height: 160px;
        border: 1.5px solid black;
        margin: 5px;
        border-radius: 10px;
        justify-content: center;
    }

    .communication {
        width: 350px;
        height: 465px;
        border: 1.5px solid black;
        margin: 5px;
        border-radius: 10px;
        justify-content: center;
        display: flex;
        flex-direction: column;
    }

    /* Smaller communication panel for phases 9-12 */
    .communication.compact {
        width: 350px;
        height: 350px;
    }

    /* Smaller communication panel for phases -1 and 0 */
    .communication.trial {
        width: 320px;
        height: 435px;
    }

    #agent_info {
        width: 460px;
        height: 140px;
        background-color: #f4f4f4;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        /* align-items: center; */
        justify-content: center;
    }

    #communication_info {
        width: 330px;
        height: 270px;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        overflow: auto;
        flex: 1;
        /* align-items: center; */
        /* justify-content: center; */
    }

    /* Compact communication info for phases 9-12 */
    .communication.compact #communication_info {
        width: 330px;
        height: auto;
        flex: 1;
    }

    /* Trial communication info for phases -1 and 0 */
    .communication.trial #communication_info {
        width: 300px;
        height: 240px;
        flex: 1;
    }

    /* Compact mode adjustments for phases 9-12 */
    .communication.compact .agent_tiny_div,
    .communication.compact .human_tiny_div {
        font-size: 0.85em;
        min-height: 20px;
        line-height: 20px;
        margin: 2px 0px;
    }

    .communication.compact .instruction_div {
        height: 26px;
        margin: 3px 0px;
        font-size: 0.8em;
    }

    .info_div {
        align-items: center;
        justify-content: center;
        display: flex;
        flex-direction: row;
        padding: 5px;
        overflow: visible;
    }

    .tiny_div {
        width: 380px;
        padding: 0px 5px;
        justify-content: center;
    }

    .timestep_div {
        width: 40px;
        padding: 0px 5px;
        align-items: center;
        justify-content: center;
    }

    .title {
        position: relative;
        top: -5px;
    }

    .agent_tiny_div {
        width: 240px;
        min-height: 22px;

        line-height: 22px;
        padding: 0px 5px;
        margin: 3px 0px;
        justify-content: center;
        align-items: center;
        text-align: start;
        background-color: #e8e8e8;
        border-radius: 5px;
        overflow: visible;
        word-break: break-word;
        font-size: 0.9em;
    }

    .human_tiny_div {
        width: 240px;
        height: 22px;
        line-height: 22px;
        padding: 0px 5px;
        margin: 3px 0px;
        justify-content: center;
        align-items: center;
        text-align: end;
        background-color: #dddddd;
        border-radius: 5px;
        word-break: break-word;
        font-size: 0.9em;
    }

    .agent_character_div {
        width: 60px;
        height: 22px;
        margin: 0px 5px;
        border-radius: 5px;
        background-color: red;
        color: white;
        text-align: center;
    }

    .human_character_div {
        width: 60px;
        height: 22px;
        margin: 0px 5px;
        border-radius: 5px;
        background-color: green;
        color: white;
        text-align: center;
    }

    #key_instruction {
        padding: 0px 5px;
        flex-shrink: 0;
    }

    .keys {
        width: 18px;
        height: 18px;
        border: 0.5px solid black;
        border-radius: 5px;
        font-size: 1.1em;
        text-align: center;
        line-height: 18px;
        margin: 0px 5px;
    }

    .keys_name_1 {
        width: 118px;
        height: 30px;
        font-size: 0.9em;
        line-height: 30px;
        text-align: left;
        /* padding: 0px 5px; */
    }

    .keys_name_2 {
        width: 47px;
        height: 30px;
        font-size: 0.9em;
        line-height: 30px;
        text-align: left;
        /* padding: 0px 5px; */
    }

    .keys_name_3 {
        width: 37px;
        height: 30px;
        font-size: 0.9em;
        line-height: 30px;
        text-align: left;
        /* padding: 0px 5px; */
    }

    .keys_name_4 {
        width: 100px;
        height: 30px;
        font-size: 0.9em;
        line-height: 30px;
        text-align: left;
        /* padding: 0px 5px; */
    }

    .instruction_div {
        display: flex;
        flex-direction: row;
        align-items: center;
        height: 28px;
        margin: 4px 0px;
        font-size: 0.85em;
    }

    .click_div {
        display: flex;
        flex-direction: row;
        align-items: center;
        border-radius: 10px;
        margin: 0px 3px;
        background-color: #f9e9cc;
    }

    :hover.click_div {
        background-color: #fff2df;
        cursor: pointer;
    }
    
    .mode_btn {
        transition: all 0.3s ease;
    }
    
    .mode_btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .mode_btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .two-col-row {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: 10px;
    }
    .two-col-left {
        flex: 1;
        margin-left: 40px;
        margin-right: 40px;
        min-width: 300px;
    }
    .two-col-right {
        min-width: 350px;
        max-width: 380px;
        margin-right: 40px;
        margin-left: 40px;
    }
    .main-game-row {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
    }
    .main-game-left {
        flex: 1;
        margin-left: 40px;
        margin-right: 40px;
    }
    .main-game-right {
        min-width: 350px;
        max-width: 380px;
        margin-right: 40px;
        margin-left: 40px;
    }
    
    /* Trial phase right column styling */
    .trial-right-column {
        min-width: 320px !important;
        max-width: 350px !important;
    }
    
    /* Game pause overlay */
    .game-pause-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        font-size: 24px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    
    /* Keyboard key styling */
    kbd {
        background-color: #f7f7f7;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 0 0 2px #fff inset;
        color: #333;
        display: inline-block;
        font-family: Arial, sans-serif;
        font-size: 11px;
        line-height: 1.4;
        margin: 0 .1em;
        padding: .1em .6em;
        text-shadow: 0 1px 0 #fff;
    }
</style>

<body>
    <!-- Popup Modal for round info -->
    <div id="roundInfoModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:32px 48px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.2); min-width:320px; text-align:center;">
            <div id="popup_info_black" style="font-size: 1.2em; margin-bottom: 10px;">You are controlling the agent with <span style='color:#000'>BLACK</span> hat.</div>
            <div id="popup_info_partner" style="font-size: 1.2em; margin-bottom: 10px;">Your partner is the agent with <span style='color:rgb(68,153,113)'>GREEN</span> hat.</div>
            <div id="popup_info_round" style="font-size: 1.2em; margin-bottom: 20px;">This is the <span id="popup_round_num"></span>/4 round game.</div>
            <button id="closeRoundInfoModal" style="padding: 8px 32px; font-size: 1em; border-radius: 6px; background: #007bff; color: white; border: none; cursor: pointer;">Start</button>
        </div>
    </div>
    <div style="display: flex; align-items: flex-start; flex-direction: row; width: 100vw; height: 100vh;">
        <!-- Left column: Game canvas -->
        <div style="flex: 1; display: flex; justify-content: center; align-items: flex-start; margin-left: 40px; margin-right: 40px; margin-top: 32px;">
            <div id="game-canvas" style="position: relative;">
                <!-- Game pause overlay -->
                <div id="gamePauseOverlay" class="game-pause-overlay">
                    <div>GAME PAUSED</div>
                </div>
            </div>
        </div>
        <!-- Right column: Info rows, mode switch, message window -->
        <div style="display: flex; flex-direction: column; min-width: 350px; max-width: 380px; margin-right: 40px; margin-left: 40px; height: 100vh; margin-top: 32px;">
            <!-- Info rows -->
            <div id="info-rows" style="margin-bottom: 16px;">
                <div style="font-size: larger;">
                    You are controlling the agent with <span style="color: #000000">BLACK</span> hat.
                </div>
                <div style="font-size: larger;" id="partner_color">
                    Your partner is the agent with <span id="idx-1" style="color: #1c70ca; display: none">BLUE</span> <span id="idx0" style="color: #c30000; display: none;">RED</span><span
                        id="idx3" style="color: rgb(68, 153, 113); display: none;">GREEN</span> <span id="idx2" style="color: #da4bd2; display: none">PINK</span> <span id="idx1" style="color: #dc742a; display: none">ORANGE</span> hat.
                </div>
                <div style="font-size: larger; display: none" id="trail_info">
                    This is the TRAIL game.<br>
                </div>
                <div style="font-size: larger; display: none" id="human_test">
                    This is the Level Testing game. Please try to achieve a score as higher as possible. <br>
                </div>
                <div style="font-size: larger; display: none" id="main_game">
                    This is the <span id="game_id"></span>/<span id="max_id"></span> round game.
                </div>
                <div style="font-size: larger;" id="wait">
                    <span>You are waiting for the game to start, Refresh your web. <br>
                    </span>
                </div>
            </div>
            <!-- Mode switch container -->
            <div id="mode_switch_container" style="display: none; margin-bottom: 16px;">
                <div style="font-size: larger; margin-bottom: 10px;">
                    <strong>Agent Control Mode:</strong>
                    <span id="current_mode" style="color: #007bff; font-weight: bold;">AI-led</span>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="ai_led_btn" class="mode_btn" style="padding: 10px 20px; border: 2px solid #007bff; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        AI-led Mode
                    </button>
                    <button id="human_led_btn" class="mode_btn" style="padding: 10px 20px; border: 2px solid #28a745; background-color: #28a745; color: white; border-radius: 5px; cursor: pointer; font-size: 14px;">
                        Human-led Mode
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">
                    <div>AI-led: Agent sends instructions to you</div>
                    <div>Human-led: You send instructions to agent</div>
                    <div style="margin-top: 5px; font-weight: bold; color: #007bff;">Press <kbd>Shift</kbd> to toggle modes</div>
                </div>
            </div>
            <!-- Message window -->
            <div style="display: flex; align-items: center; flex-direction: column; flex: 1;">
                <div class="title"></div>
                <div class="communication" id="communication">
                    <div id="communication_info"></div>
                    <div id="key_instruction">
                        <hr />
                        <div class="instruction_div">Click below buttons or press the shortcuts to send messages:<br>：</div>
                        <div class="instruction_div" style="gap: 8px;">
                            <div class="click_div" id="button_1">
                                <div class="keys">1</div>
                                <div class="keys_name_2">Lettuce</div>
                            </div>
                            <div class="click_div" id="button_2">
                                <div class="keys">2</div>
                                <div class="keys_name_2">Beef</div>
                            </div>
                            <div class="click_div" id="button_3">
                                <div class="keys">3</div>
                                <div class="keys_name_2">Bread</div>
                            </div>
                        </div>
                        <div class="instruction_div" style="gap: 8px;">
                            <div class="click_div" id="button_4">
                                <div class="keys">4</div>
                                <div class="keys_name_2">Plate</div>
                            </div>
                            <div class="click_div" id="button_5">
                                <div class="keys">5</div>
                                <div class="keys_name_2">Fire</div>
                            </div>
                            <div class="click_div" id="button_6">
                                <div class="keys">6</div>
                                <div class="keys_name_4">Good job!</div>
                            </div>
                        </div>
                        <!--
                        <div class="instruction_div">
                            <div class="click_div" id="button_1">
                                <div class="keys">1</div>
                                <div class="keys_name_1">LettuceBurger</div>
                            </div>
                            <div class="click_div" id="button_4">
                                <div class="keys">4</div>
                                <div class="keys_name_2">Lettuce</div>
                            </div>
                            <div class="click_div" id="button_7">
                                <div class="keys">7</div>
                                <div class="keys_name_3">Plate</div>
                            </div>
                            <div class="click_div" id="button_10">
                                <div class="keys">=</div>
                                <div class="keys_name_4">Good Job!</div>
                            </div>
                        </div>
                        <div class="instruction_div">
                            <div class="click_div" id="button_2">
                                <div class="keys">2</div>
                                <div class="keys_name_1">BeefBurger</div>
                            </div>
                            <div class="click_div" id="button_5">
                                <div class="keys">5</div>
                                <div class="keys_name_2">Beef</div>
                            </div>
                            <div class="click_div" id="button_8">
                                <div class="keys">8</div>
                                <div class="keys_name_3">Serve</div>
                            </div>
                            <div class="click_div" id="button_11">
                                <div class="keys">-</div>
                                <div class="keys_name_4">Need Improvement</div>
                            </div>
                        </div>
                        <div class="instruction_div">
                            <div class="click_div" id="button_3">
                                <div class="keys">3</div>
                                <div class="keys_name_1">BeefLettuceBurger</div>
                            </div>
                            <div class="click_div" id="button_6">
                                <div class="keys">6</div>
                                <div class="keys_name_2">Bread</div>
                            </div>
                            <div class="click_div" id="button_9">
                                <div class="keys">9</div>
                                <div class="keys_name_3">Fire</div>
                            </div>
                        </div>
                        -->
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script>
        // Game pause/resume functionality
        let gamePaused = false;
        // Current mode tracking for toggle functionality
        let currentMode = 'ai_led'; // Default mode

        // Debug functions for testing random assignment
        window.clearPhaseStorage = function() {
            sessionStorage.removeItem('phase9ModeSet');
            sessionStorage.removeItem('phase10ModeSet');
            sessionStorage.removeItem('phase9RandomMode');
            sessionStorage.removeItem('phase10RandomMode');
            console.log('Cleared all phase storage - random assignment will work on next phase entry');
        };

        window.checkPhaseStorage = function() {
            console.log('Phase 9 mode set:', sessionStorage.getItem('phase9ModeSet'));
            console.log('Phase 9 random mode:', sessionStorage.getItem('phase9RandomMode'));
            console.log('Phase 10 mode set:', sessionStorage.getItem('phase10ModeSet'));
            console.log('Phase 10 random mode:', sessionStorage.getItem('phase10RandomMode'));
        };

        window.forceRandomMode = function(phase) {
            if (phase === 9) {
                sessionStorage.removeItem('phase9ModeSet');
                var randomMode = Math.random() < 0.5 ? 'human_led' : 'ai_led';
                console.log('Forcing Phase 9 random mode:', randomMode);
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send("MODE_SWITCH:" + randomMode);
                }
            } else if (phase === 10) {
                sessionStorage.removeItem('phase10ModeSet');
                var randomMode = Math.random() < 0.5 ? 'human_led' : 'ai_led';
                console.log('Forcing Phase 10 random mode:', randomMode);
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send("MODE_SWITCH:" + randomMode);
                }
            }
        };

        function pauseGame() {
            gamePaused = true;
            // Show pause overlay
            document.getElementById('gamePauseOverlay').style.display = 'flex';
            // Send pause command to backend
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send("GAME_PAUSE");
                console.log("Game paused for questionnaire");
            }
        }

        function resumeGame() {
            gamePaused = false;
            // Hide pause overlay
            document.getElementById('gamePauseOverlay').style.display = 'none';
            // Send resume command to backend
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send("GAME_RESUME");
                console.log("Game resumed after questionnaire");
            }
        }

        function switchToMode(mode) {
            // Only allow mode switching for phases 9, 10, 11, 12
            if (!(gamephase == 9 || gamephase == 10 || gamephase == 11 || gamephase == 12)) {
                return;
            }

            // Handle fake button modal for phases 11, 12
            if (gamephase == 11 || gamephase == 12) {
                showFakeButtonModal();
                return;
            }

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                if (mode === 'ai_led') {
                    websocket.send("MODE_SWITCH:ai_led");
                    document.getElementById('current_mode').innerText = "AI-led";
                    document.getElementById('current_mode').style.color = "#007bff";
                    // Update button styles
                    document.getElementById('ai_led_btn').style.backgroundColor = "#007bff";
                    document.getElementById('ai_led_btn').style.borderColor = "#007bff";
                    document.getElementById('human_led_btn').style.backgroundColor = "#6c757d";
                    document.getElementById('human_led_btn').style.borderColor = "#6c757d";
                    currentMode = 'ai_led';
                } else if (mode === 'human_led') {
                    websocket.send("MODE_SWITCH:human_led");
                    document.getElementById('current_mode').innerText = "Human-led";
                    document.getElementById('current_mode').style.color = "#28a745";
                    // Update button styles
                    document.getElementById('human_led_btn').style.backgroundColor = "#28a745";
                    document.getElementById('human_led_btn').style.borderColor = "#28a745";
                    document.getElementById('ai_led_btn').style.backgroundColor = "#6c757d";
                    document.getElementById('ai_led_btn').style.borderColor = "#6c757d";
                    currentMode = 'human_led';
                }
            }
        }

        function toggleMode() {
            // Toggle between ai_led and human_led
            if (currentMode === 'ai_led') {
                switchToMode('human_led');
            } else {
                switchToMode('ai_led');
            }
        }

        function getDomData() {
            var userInfo = JSON.parse(sessionStorage.getItem('before_game')) || {}
            var gamephase = sessionStorage.getItem('gamephase')
            var params = {
                name: userInfo.name,
                phone: userInfo.phone,
                gamephase: gamephase,
            }
            console.log('params', params)
            return params
        }
        var userInfo = sessionStorage.getItem('before_game')
        if (!userInfo) {
            // window.location.href = "/html/before_game"
            window.location.href = "/html/statement";
        }
        else {

            // console.log(userInfo)
            var canvasWidth = 650;
            var canvasHeight = 650;


            var canvasElement = document.createElement('canvas');
            canvasElement.width = canvasWidth;
            canvasElement.height = canvasHeight;
            document.getElementById('game-canvas').appendChild(canvasElement);
            var context = canvasElement.getContext('2d');

            var image = new Image()

            image.onload = function () {
                console.log('onload')
                context.drawImage(image, 0, 0, canvasElement.width, canvasElement.height);
            }


            // console.log('hello')
            // var ID = sessionStorage.getItem('agentID')
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/getsettings", false); // false for synchronous
            // xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(userInfo);
            var response = JSON.parse(xhr.response);
            var agentID = response['agentid'];
            var trajname = response['trajname'];
            var exp_type = response['type'];
            var game_sequence_idx = response["game_sequence_idx"];
            var time = response["max_steps"];


            var xhr = new XMLHttpRequest();
            xhr.open("POST", '/' + agentID + '/getphase', false);
            xhr.send(userInfo);
            var response = JSON.parse(xhr.response);
            var gamephase = response['gamephase'];
            var lastphase = response['lastphase'];
            var maxphase = response['maxphase'];
            var to_questionnaire = response['to_questionnaire'];
            console.log(response)
            console.log("gamephase", gamephase)
            console.log("lastphase", lastphase)
            console.log("maxphase", maxphase)
            console.log("to_questionnaire", to_questionnaire)

            if (gamephase == -1) {
                document.getElementById('trail_info').style = "font-size: larger; display: content"
                document.getElementById('partner_color').style = "font-size: larger; display: none"
                // Apply trial style to communication panel for smaller size
                document.getElementById('communication').classList.add('trial');
                // Apply trial style to right column
                document.querySelector('div[style*="min-width: 350px; max-width: 380px"]').classList.add('trial-right-column');
            }
            else if (gamephase == 0) {
                document.getElementById('human_test').style = "font-size: larger; display: content"
                document.getElementById('partner_color').style = "font-size: larger; display: none"
                // Apply trial style to communication panel for smaller size
                document.getElementById('communication').classList.add('trial');
                // Apply trial style to right column
                document.querySelector('div[style*="min-width: 350px; max-width: 380px"]').classList.add('trial-right-column');
            }
            else if (gamephase > 6) {
                document.getElementById('idx3').style = "color: rgb(68, 153, 113); display: content;"
                document.getElementById('main_game').style = "font-size: larger; display: content"
                // For official phases 9-12, show as round 1-4
                if (gamephase >= 9 && gamephase <= 12) {
                    document.getElementById('game_id').innerText = gamephase - 8; // 9->1, 10->2, 11->3, 12->4
                    document.getElementById('max_id').innerText = 4;
                } else {
                    document.getElementById('game_id').innerText = game_sequence_idx;
                    document.getElementById('max_id').innerText = maxphase;
                }
            }
            else if (gamephase > 4) {
                document.getElementById('idx2').style = "color: #da4bd2; display: content;"
                document.getElementById('main_game').style = "font-size: larger; display: content"
                document.getElementById('game_id').innerText = game_sequence_idx;
                document.getElementById('max_id').innerText = maxphase;
            }
            else if (gamephase > 2) {
                document.getElementById('idx1').style = "color: #dc742a; display: content;"
                document.getElementById('main_game').style = "font-size: larger; display: content"
                document.getElementById('game_id').innerText = game_sequence_idx;
                document.getElementById('max_id').innerText = maxphase;
            }
            else if (gamephase >= 1) {
                document.getElementById('idx0').style = "color: #c30000; display: content;"
                document.getElementById('main_game').style = "font-size: larger; display: content"
                document.getElementById('game_id').innerText = game_sequence_idx;
                document.getElementById('max_id').innerText = maxphase;
            }
            
            // Show mode switch button only for phases 9, 10, 11, 12
            if (gamephase == 9 || gamephase == 10 || gamephase == 11 || gamephase == 12) {
                document.getElementById('mode_switch_container').style.display = "block";
                // Adjust canvas size for formal game phases (smaller for Windows screen)
                canvasWidth = 620;
                canvasHeight = 560;
                canvasElement.width = canvasWidth;
                canvasElement.height = canvasHeight;
                // Apply compact style to communication panel
                document.getElementById('communication').classList.add('compact');
                // Hide the hat color information for formal phases
                document.querySelector('div[style="font-size: larger;"]').style.display = "none";
                document.getElementById('partner_color').style.display = "none";
            }
            else if (gamephase == null) {
                alert("You have finished the experiment.")
                window.location.href = "/html/info_confirm";
            }
            // document.getElementById('index').innerText = agentID;
            // if (agentID % 2 == 0) {
            //     document.getElementById('idx0').style = "color: #1c70ca; display: content;"
            // } else {
            //     document.getElementById('idx1').style = "color: rgb(68, 153, 113); display: content;"
            // }

            // console.log(agentID);
            // console.log(trajname);
            // console.log('trajname')
            sessionStorage.setItem('agentID', agentID)
            sessionStorage.setItem('trajname', trajname)
            sessionStorage.setItem('exptype', exp_type)
            sessionStorage.setItem('gamephase', gamephase)
            sessionStorage.setItem('lastphase', lastphase)
            // console.log(trajname)
            domData = getDomData();
            domData['traj_id'] = trajname;
            console.log(domData)

            if (to_questionnaire) {
                alert("You have finished this round, please fill in the questionnaire.")
                window.location.href = "/html/in_game";
            }

            if (exp_type == 'A') {
                document.getElementById('key_instruction').style = "display: none"
            } else if (exp_type == 'N') {
                document.getElementById('communication').style = "display: none"
            }

            // sessionStorage.setItem("")

            // randomize for phase 9/10 BEFORE WebSocket connection
            console.log('Checking phase', gamephase, 'for random mode assignment');
            console.log('Phase 9 mode set check:', sessionStorage.getItem('phase9ModeSet'));
            console.log('Phase 10 mode set check:', sessionStorage.getItem('phase10ModeSet'));
            
            if (gamephase == 9 && !sessionStorage.getItem('phase9ModeSet')) {
                sessionStorage.setItem('phase9ModeSet', '1');
                // randomize human_led 或 ai_led
                var randomMode = Math.random() < 0.5 ? 'human_led' : 'ai_led';
                console.log('Phase 9: Randomly assigned mode:', randomMode);
                
                // Store the randomly assigned mode to verify later
                sessionStorage.setItem('phase9RandomMode', randomMode);
                console.log('Phase 9: Stored random mode for later WebSocket sending');
            } else if (gamephase == 9) {
                console.log('Phase 9: Mode already set, skipping random assignment');
                console.log('Phase 9: Previously assigned mode:', sessionStorage.getItem('phase9RandomMode'));
            }
            
            if (gamephase == 10 && !sessionStorage.getItem('phase10ModeSet')) {
                sessionStorage.setItem('phase10ModeSet', '1');
                // randomize human_led 或 ai_led
                var randomMode = Math.random() < 0.5 ? 'human_led' : 'ai_led';
                console.log('Phase 10: Randomly assigned mode:', randomMode);
                
                // Store the randomly assigned mode to verify later
                sessionStorage.setItem('phase10RandomMode', randomMode);
                console.log('Phase 10: Stored random mode for later WebSocket sending');
            } else if (gamephase == 10) {
                console.log('Phase 10: Mode already set, skipping random assignment');
                console.log('Phase 10: Previously assigned mode:', sessionStorage.getItem('phase10RandomMode'));
            }

            var websocket = new WebSocket(
                "ws://" + window.location.hostname + ":63000/" + agentID + "/connect"
            );// var socket = io.connect();
            
            // Send random mode immediately when WebSocket opens
            websocket.onopen = function() {
                console.log('WebSocket opened');
                
                // Send random mode for phase 9
                if (gamephase == 9) {
                    var randomMode = sessionStorage.getItem('phase9RandomMode');
                    if (randomMode) {
                        console.log('Phase 9: Sending random mode on WebSocket open:', randomMode);
                        websocket.send("MODE_SWITCH:" + randomMode);
                    }
                }
                
                // Send random mode for phase 10
                if (gamephase == 10) {
                    var randomMode = sessionStorage.getItem('phase10RandomMode');
                    if (randomMode) {
                        console.log('Phase 10: Sending random mode on WebSocket open:', randomMode);
                        websocket.send("MODE_SWITCH:" + randomMode);
                    }
                }
            };
            
            // Add a global flag to control if human can send messages
            var allowHumanMessage = true;

            websocket.onmessage = function (msg) {
                // console.log(msg)
                // console.log(msg.data)
                const data = JSON.parse(msg.data);
                const imgData = data['frame'];
                const dataUrl = 'data:image/png;base64,' + imgData;

                communication_info_div = document.getElementById('communication_info')
                communication_info_div.innerHTML = ""
                // console.log(data['info_list'])

                for (var i = 0; i < data['info_list'].length; i++) {
                    info_div = document.createElement('div')
                    info_div.setAttribute('class', 'info_div')
                    timestep_div = document.createElement('div')
                    timestep_div.setAttribute('class', 'timestep_div')
                    timestep_div.innerHTML = data['info_list'][i][3]
                    tiny_div = document.createElement('div')
                    tiny_div.setAttribute('class', 'tiny_div')

                    if (data['info_list'][i][0] == 'human') {
                        tiny_div.setAttribute('class', 'human_tiny_div')
                        tiny_div.innerHTML = data['info_list'][i][1] + ", " + data['info_list'][i][2]
                        character_div = document.createElement('div')
                        character_div.setAttribute('class', 'human_character_div')
                        character_div.innerHTML = "You"
                        // console.log(character_div)
                        info_div.appendChild(tiny_div)
                        info_div.appendChild(character_div)

                    } else {
                        tiny_div.setAttribute('class', 'agent_tiny_div')
                        tiny_div.innerHTML = data['info_list'][i][1] + ", " + data['info_list'][i][2]
                        character_div = document.createElement('div')
                        character_div.setAttribute('class', 'agent_character_div')
                        character_div.innerHTML = "Agent"
                        // console.log(character_div)
                        info_div.appendChild(character_div)
                        info_div.appendChild(tiny_div)
                    }
                    // info_div.appendChild(timestep_div)
                    communication_info_div.appendChild(info_div)
                }
                communication_info_div.scrollTop = communication_info_div.scrollHeight;

                // Update mode display if available
                if (typeof data['agent_mode'] !== 'undefined' && (gamephase == 9 || gamephase == 10 || gamephase == 11 || gamephase == 12)) {
                    const mode = data['agent_mode'];
                    console.log('WebSocket received agent_mode:', mode, 'for phase:', gamephase);
                    
                    // Check if this conflicts with our random assignment
                    if (gamephase == 9) {
                        const expectedMode = sessionStorage.getItem('phase9RandomMode');
                        if (expectedMode && expectedMode !== mode) {
                            console.warn('Phase 9: Backend mode (' + mode + ') differs from random assignment (' + expectedMode + ')');
                        }
                    }
                    if (gamephase == 10) {
                        const expectedMode = sessionStorage.getItem('phase10RandomMode');
                        if (expectedMode && expectedMode !== mode) {
                            console.warn('Phase 10: Backend mode (' + mode + ') differs from random assignment (' + expectedMode + ')');
                        }
                    }
                    
                    if (mode === 'ai_led') {
                        document.getElementById('current_mode').innerText = "AI-led";
                        document.getElementById('current_mode').style.color = "#007bff";
                        document.getElementById('ai_led_btn').style.backgroundColor = "#007bff";
                        document.getElementById('ai_led_btn').style.borderColor = "#007bff";
                        document.getElementById('human_led_btn').style.backgroundColor = "#6c757d";
                        document.getElementById('human_led_btn').style.borderColor = "#6c757d";
                        document.getElementById('key_instruction').style.display = 'none';
                        allowHumanMessage = false;
                    } else if (mode === 'human_led') {
                        document.getElementById('current_mode').innerText = "Human-led";
                        document.getElementById('current_mode').style.color = "#28a745";
                        document.getElementById('human_led_btn').style.backgroundColor = "#28a745";
                        document.getElementById('human_led_btn').style.borderColor = "#28a745";
                        document.getElementById('ai_led_btn').style.backgroundColor = "#6c757d";
                        document.getElementById('ai_led_btn').style.borderColor = "#6c757d";
                        document.getElementById('key_instruction').style.display = '';
                        allowHumanMessage = true;
                    } else if (mode === 'human_only') {
                        // For phase -1 and 0: always allow human message, hide mode switch
                        allowHumanMessage = true;
                        document.getElementById('mode_switch_container').style.display = "none";
                        document.getElementById('key_instruction').style.display = '';
                    }
                } else if (gamephase == -1 || gamephase == 0) {
                    // In warmup/trial, always allow human to send messages, hide mode switch
                    allowHumanMessage = true;
                    document.getElementById('mode_switch_container').style.display = "none";
                    document.getElementById('key_instruction').style.display = '';
                }

                if (data['time'] != time) {
                    document.getElementById("wait").style = "display:none"
                }
                image.src = dataUrl;
                console.log(data['time'])
                if (data['time'] == 0) {
                    if (gamephase == -1) {
                        alert("Trail game finished, the experiment will start.")
                        alert("The next experiment measures how well you play this game.")
                    }
                    else {
                        alert("Game finished.")
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/save_traj_info", false); // false for synchronous
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify(domData));
                    websocket.close();
                    window.location.href = "/html/in_game"
                }
            }

            // Update button click handler to check allowHumanMessage
            // Only 6 buttons now, update logic accordingly
            for (var i = 1; i <= 6; i++) {
                button = document.getElementById('button_' + i)
                button.addEventListener('click', function () {
                    if (!allowHumanMessage) return;
                    var action = 0
                    var instruction = 0
                    var feedback = 0
                    switch (this.id) {
                        case 'button_1': instruction = 4; break; // Lettuce
                        case 'button_2': instruction = 5; break; // Beef
                        case 'button_3': instruction = 6; break; // Bread
                        case 'button_4': instruction = 7; break; // Plate
                        case 'button_5': instruction = 9; break; // Fire
                        case 'button_6': feedback = 1; break; // Good job!
                        default: break;
                    }
                    if (instruction != 0 || feedback != 0) {
                        websocket.send(`${action} ${instruction} ${feedback}`);
                    }
                })
            }
            /*
            // Old button logic (commented for reference)
            for (var i = 1; i < 12; i++) {
                button = document.getElementById('button_' + i)
                button.addEventListener('click', function () {
                    if (!allowHumanMessage) return;
                    var action = 0
                    var instruction = 0
                    var feedback = 0
                    switch (this.id) {
                        case 'button_1': instruction = 1; break;
                        case 'button_2': instruction = 2; break;
                        case 'button_3': instruction = 3; break;
                        case 'button_4': instruction = 4; break;
                        case 'button_5': instruction = 5; break;
                        case 'button_6': instruction = 6; break;
                        case 'button_7': instruction = 7; break;
                        case 'button_8': instruction = 8; break;
                        case 'button_9': instruction = 9; break;
                        case 'button_10': feedback = 1; break;
                        case 'button_11': feedback = 2; break;
                        default: break;
                    }
                    if (instruction != 0 || feedback != 0) {
                        websocket.send(`${action} ${instruction} ${feedback}`);
                    }
                })
            }
            */
            // Update keydown handler to check allowHumanMessage for message keys
            document.addEventListener('keydown', function (e) {
                var action = 0
                var instruction = 0
                var feedback = 0
                // AGENT_ACTIONS: 0: Noop, 1: Left, 2: right, 3: down, 4: up, 5: interact
                switch (e.key) {
                    case 'a': case 'A': case 'ArrowLeft': action = 1; break;
                    case 'w': case 'W': case 'ArrowUp': action = 4; break;
                    case 'd': case 'D': case 'ArrowRight': action = 2; break;
                    case 's': case 'S': case 'ArrowDown': action = 3; break;
                    case ' ': case 'Spacebar': action = 5; break;
                    case '1': instruction = 4; break; // Lettuce
                    case '2': instruction = 5; break; // Beef
                    case '3': instruction = 6; break; // Bread
                    case '4': instruction = 7; break; // Plate
                    case '5': instruction = 9; break; // Fire
                    case '6': feedback = 1; break; // Good job!
                    case 'Shift': 
                        // Toggle mode switch with Shift key
                        e.preventDefault(); // Prevent default Shift behavior
                        toggleMode();
                        return; // Don't send to websocket
                    default: break;
                }
                // Only allow sending messages if allowed
                if ((instruction != 0 || feedback != 0) && !allowHumanMessage) return;
                if (action != 0 || instruction != 0 || feedback != 0) {
                    websocket.send(`${action} ${instruction} ${feedback}`);
                }
            });
            /*
            // Old keydown logic (commented for reference)
            document.addEventListener('keydown', function (e) {
                var action = 0
                var instruction = 0
                var feedback = 0
                // AGENT_ACTIONS: 0: Noop, 1: Left, 2: right, 3: down, 4: up, 5: interact
                switch (e.key) {
                    case 'a': case 'A': case 'ArrowLeft': action = 1; break;
                    case 'w': case 'W': case 'ArrowUp': action = 4; break;
                    case 'd': case 'D': case 'ArrowRight': action = 2; break;
                    case 's': case 'S': case 'ArrowDown': action = 3; break;
                    case ' ': case 'Spacebar': action = 5; break;
                    case '1': instruction = 1; break; // Lettuce
                    case '2': instruction = 2; break; // Beef
                    case '3': instruction = 3; break; // Bread
                    case '4': instruction = 4; break; // Plate
                    case '5': instruction = 5; break; // Fire
                    case '6': feedback = 1; break; // Good job!
                    default: break;
                }
                // Only allow sending messages if allowed
                if ((instruction != 0 || feedback != 0) && !allowHumanMessage) return;
                if (action != 0 || instruction != 0 || feedback != 0) {
                    websocket.send(`${action} ${instruction} ${feedback}`);
                }
            });
            */

            window.addEventListener("beforeunload", function () {

                console.log('beforeunload')
                websocket.close();
            });

            // Add popup modal for fake button (phases 11, 12)
            var fakeButtonModal = document.createElement('div');
            fakeButtonModal.id = 'fakeButtonModal';
            fakeButtonModal.style.display = 'none';
            fakeButtonModal.style.position = 'fixed';
            fakeButtonModal.style.left = '0';
            fakeButtonModal.style.top = '0';
            fakeButtonModal.style.width = '100vw';
            fakeButtonModal.style.height = '100vh';
            fakeButtonModal.style.background = 'rgba(0,0,0,0.3)';
            fakeButtonModal.style.zIndex = '1000';
            fakeButtonModal.innerHTML = `
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px 32px;border-radius:10px;box-shadow:0 2px 16px rgba(0,0,0,0.2);min-width:300px;">
                    <div style="font-size:16px;margin-bottom:10px;">Why do you press the button?</div>
                    <input id="fakeButtonReason" type="text" style="width:100%;padding:6px 8px;margin-bottom:10px;" placeholder="Your answer..." />
                    <button id="fakeButtonSubmit" style="padding:6px 18px;">Submit</button>
                    <button id="fakeButtonCancel" style="padding:6px 18px;margin-left:10px;">Cancel</button>
                </div>
            `;
            document.body.appendChild(fakeButtonModal);

            function showFakeButtonModal() {
                // Pause the game when showing questionnaire
                pauseGame();
                document.getElementById('fakeButtonReason').value = '';
                fakeButtonModal.style.display = 'block';
            }
            function hideFakeButtonModal() {
                fakeButtonModal.style.display = 'none';
                // Resume the game when hiding questionnaire
                resumeGame();
            }
            document.getElementById('fakeButtonSubmit').onclick = function() {
                const reason = document.getElementById('fakeButtonReason').value;
                // Send to backend
                fetch('/log_fake_button_press', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: userInfo ? JSON.parse(userInfo).name : '',
                        phone: userInfo ? JSON.parse(userInfo).phone : '',
                        gamephase: gamephase,
                        reason: reason,
                        timestamp: Date.now()
                    })
                });
                hideFakeButtonModal();
                alert('Thank you for your feedback!');
            };
            document.getElementById('fakeButtonCancel').onclick = function() {
                hideFakeButtonModal();
            };

            // Mode switch button event listeners
            document.getElementById('ai_led_btn').addEventListener('click', function() {
                switchToMode('ai_led');
            });
            
            document.getElementById('human_led_btn').addEventListener('click', function() {
                switchToMode('human_led');
            });

            window.addEventListener("unload", function () {

                console.log('unload')
                websocket.close();
            });

            // After determining gamephase, add logic to hide instruction images and adjust layout for phases 9-12
            if (gamephase == 9 || gamephase == 10 || gamephase == 11 || gamephase == 12) {
                // Hide instruction images
                var instrImgs = document.getElementById('instruction-images');
                if (instrImgs) instrImgs.style.display = 'none';
                // Adjust top info row layout (already set by default)
                document.getElementById('top-info-row').style.display = 'flex';
            } else {
                // Show instruction images for other phases
                var instrImgs = document.getElementById('instruction-images');
                if (instrImgs) instrImgs.style.display = 'flex';
            }

            // Set up instruction images and canvas size for trial rounds (phase 0 and 1)
            if (gamephase == -1 || gamephase == 0) {
                // Show instruction images
                let instrImgs = document.getElementById('instruction-images');
                if (!instrImgs) {
                    instrImgs = document.createElement('div');
                    instrImgs.id = 'instruction-images';
                    instrImgs.style.display = 'flex';
                    instrImgs.style.alignItems = 'center';
                    instrImgs.style.flexDirection = 'column';
                    instrImgs.innerHTML = `
                        <img src="/static/images/beefburger.png" style="width:220px">
                        <img src="/static/images/fire.png" style="width:220px">
                        <img src="/static/images/lettuceburger.png" style="width:220px">
                        <img src="/static/images/beeflettuceburger.png" style="width:220px">
                    `;
                    // Insert before game-canvas
                    var leftCol = document.querySelector('div[style*="flex: 1;"]');
                    if (leftCol) leftCol.insertBefore(instrImgs, leftCol.firstChild);
                } else {
                    instrImgs.style.display = 'flex';
                }
                // Set canvas size to 450x570 (reduced by 10px more from 460x580)
                canvasWidth = 450;
                canvasHeight = 570;
            } else {
                // Hide instruction images if present
                var instrImgs = document.getElementById('instruction-images');
                if (instrImgs) instrImgs.style.display = 'none';
                // Use the current canvas size (650x650 or whatever is set)
                canvasWidth = 650;
                canvasHeight = 650;
            }
            // Update canvas size
            if (canvasElement) {
                canvasElement.width = canvasWidth;
                canvasElement.height = canvasHeight;
            }

            // Show popup before phases 9, 10, 11, 12
            if (gamephase == 9 || gamephase == 10 || gamephase == 11 || gamephase == 12) {
                // Calculate round number (1/4, 2/4, 3/4, 4/4)
                var roundNum = 1;
                if (gamephase == 9) roundNum = 1;
                if (gamephase == 10) roundNum = 2;
                if (gamephase == 11) roundNum = 3;
                if (gamephase == 12) roundNum = 4;
                document.getElementById('popup_round_num').innerText = roundNum;
                document.getElementById('roundInfoModal').style.display = 'block';
                // Pause game logic until modal is closed
                document.getElementById('closeRoundInfoModal').onclick = function() {
                    document.getElementById('roundInfoModal').style.display = 'none';
                };
            }

            // automatically switch mode for phase 11/12
            if (gamephase == 11 && !sessionStorage.getItem('phase11ModeSet')) {
                sessionStorage.setItem('phase11ModeSet', '1');
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send("MODE_SWITCH:human_led");
                } else {
                    websocket.addEventListener('open', function() {
                        websocket.send("MODE_SWITCH:human_led");
                    }, { once: true });
                }
            }
            if (gamephase == 12 && !sessionStorage.getItem('phase12ModeSet')) {
                sessionStorage.setItem('phase12ModeSet', '1');
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send("MODE_SWITCH:ai_led");
                } else {
                    websocket.addEventListener('open', function() {
                        websocket.send("MODE_SWITCH:ai_led");
                    }, { once: true });
                }
            }
        }

    </script>
</body>

</html>
